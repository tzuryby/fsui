{% extends "base.html" %}

{% block body %}
<div class="reactor-in-action hide-on-load"></div>
<center>
    <div class="hide-on-load ui-corner-all" id="notification_div">
        <p id="notification_message">
        </p>
    </div>
</center>

<div id="main_tabs">
	<ul>
		<li><a href="#tabs-dashboard">{{_("Dashboard")}}</a></li>
		<li><a href="#tabs-conference">{{_("Confenernces")}}</a></li>
		<li><a href="#tabs-cli">{{_("CLI")}}</a></li>
		<li><a href="#tabs-diagnostics">{{_("Diagnostics")}}</a></li>
		<li><a href="#tabs-settings">{{_("Settings")}}</a></li>
	</ul>
	<div id="tabs-dashboard">
        <div id="dashboard-users"></div>
    </div>
	<div id="tabs-conference">
        <div id="conferences-profiles"></div>
    </div>
	<div id="tabs-cli">
        <input 
            id="cli-input" type="text" placeholder='{{_("Enter FS CLI command")}}' 
            class="wide-input ui-widget-content ui-corner-all" />
        <div id="cli-output"></div>
    </div>
	<div id="tabs-diagnostics">Comming Soon...</div>
	<div id="tabs-settings">Comming Soon...</div>
</div>

<script type="text/javascript">

$(document).ready(function(){
    
    $(".hide-on-load").hide();
    
    // in case someone decided to use IE6 -- LULZec come over here ;-)
    window.console = window.console || {log: function(){}}
    
    // tabify dashboard
    $("#main_tabs").tabs({ cookie: { expires: 30 } });
    
    
    var IAmBusy = {
        show: function(){ $('.reactor-in-action').show()},
        hide: function(){ $('.reactor-in-action').hide()}
    }    
    
    // bind cli interaction
    $("#cli-input").keypress(
        function(evt){
            var keyCode = evt.keyCode;        
            if (keyCode === 13){
                var user_input = $(this).val();
                var xcommand =  user_input || "sofia status profile internal"
                if (!user_input)
                    $(this).val(xcommand);
                    
                var url = "/cli", 
                    params = {"x": xcommand};
                    
                $("#cli-output").load(url, params);
                $("#cli-output").css("height", "70%");
            }
        }
    );
    
    dashBoard = {
        loopId: 0,
        uiHandler: function(){
            $(".hideme").hide();
            var more_info_button_selector = $(".moreinfo-qtip");
            
            more_info_button_selector
                .each(function(){
                    $(this).qtip({
                         content: {
                            text: $("#tip_frame_" + $(this).attr("rel")),
                            title: {
                               text: $(this).attr("rel") + '{{_(" details")}}',
                               button: 'x' 
                            }
                         },
                         position: {
                            corner: { target: 'bottomLeft', tooltip: 'topMiddle'},
                            adjust: { screen: true }
                         },
                         show: { when: 'click', solo: true },
                         hide: 'unfocus',
                         style: {
                            tip: true, 
                            border: {
                               width: 0,
                               radius: 4
                            },
                            name: 'light', 
                            width: 220 
                         },
                         api: {
                            onShow: function(e){
                                dashBoard.stopLoop();
                                $(".qtip-wrapper .in-place-edit").editable({
                                    onSubmit:inline_editor_save
                                });
                            },
                            onHide: function(e){
                                dashBoard.startLoop()
                            }
                        }
                  });
                });
            IAmBusy.hide();
            
        }, 
        loader:    function(){ IAmBusy.show(); $("#dashboard-users").load("/dashboard", dashBoard.uiHandler); },
        startLoop: function(){ dashBoard.loopId = window.setInterval(dashBoard.loader, 8*1000) },
        stopLoop:  function(){ dashBoard.loopId && window.clearInterval(dashBoard.loopId);},        
        restart:   function(){ dashBoard.loader(); dashBoard.startLoop(); }
    }
        
    

    function inline_editor_save(content){
        // checkbox click 
        if (!content.previous){
            content = {current:1, previous:0}
        }
        
        if (content.current !== content.previous){
            var _this = $(this),
                extension = _this.attr("rel"),
                password = content.current;
            
            IAmBusy.show();
            
            $.post(
                "/admin/set/extension/password", 
                { extension: extension, password: password, "vm-password": password },
                function(){IAmBusy.hide();}
            );
        }        
    }
    
    var conferences = {        
        load: function(url, params, callback){
                IAmBusy.show()
                url = url || "/admin/set/conferences"
                params = params || {};
                callback = callback || IAmBusy.hide;
                
                $("#conferences-profiles").load(url, params, callback);
        },
        
        save: function(){
            var pin = $(this).val(),
                profile = $(this).attr("rel");
                
            confrences.load("/admin/set/conferences", {pin: pin, profile: profile}, IAmBusy.hide);
        }
    }
    
    dashBoard.restart();
    conferences.load();

});


</script>

{% end %}



